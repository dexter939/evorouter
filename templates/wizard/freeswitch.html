{% extends "layout.html" %}

{% block title %}Setup Wizard - FreeSWITCH Configuration - BPI-R4 Router{% endblock %}

{% block extra_css %}
<style>
    .wizard-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .wizard-steps {
        display: flex;
        margin-bottom: 30px;
    }
    
    .wizard-step {
        flex: 1;
        padding: 10px;
        background-color: #f8f9fa;
        text-align: center;
        border-radius: 4px;
        margin-right: 5px;
    }
    
    .wizard-step.active {
        background-color: #0d6efd;
        color: white;
    }
    
    .wizard-step.completed {
        background-color: #198754;
        color: white;
    }
    
    .wizard-content {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 20px;
    }
    
    .wizard-nav-buttons {
        margin-top: 30px;
        display: flex;
        justify-content: space-between;
    }
    
    .extension-preview {
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 15px;
        margin-top: 20px;
    }
    
    .extension-preview h6 {
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 8px;
        margin-bottom: 12px;
    }
    
    .extension-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px dashed #dee2e6;
    }
    
    .extension-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-magic me-2"></i>Router Setup Wizard</h1>
</div>

<div class="wizard-container">
    <!-- Wizard Steps -->
    <div class="wizard-steps">
        <div class="wizard-step completed">
            <i class="fas fa-network-wired me-1"></i> Network
        </div>
        <div class="wizard-step active">
            <i class="fas fa-phone me-1"></i> FreeSWITCH
        </div>
    </div>
    
    <!-- Wizard Content -->
    <div class="wizard-content">
        <h4 class="mb-4 text-center">FreeSWITCH PBX Configuration</h4>
        
        <form method="POST" action="{{ url_for('wizard.freeswitch_setup') }}" class="wizard-form">
            {{ form.hidden_tag() }}
            
            <div class="mb-4 form-check form-switch">
                {{ form.enable_freeswitch(class="form-check-input", id="enable_freeswitch") }}
                <label class="form-check-label" for="enable_freeswitch">Enable FreeSWITCH PBX</label>
                <div class="form-text">Configure your router as a phone system for VoIP calls</div>
            </div>
            
            <div id="freeswitch-settings">
                <!-- Basic PBX Settings -->
                <h5 class="mt-4 mb-3"><i class="fas fa-building me-2"></i>Company Information</h5>
                
                <div class="mb-3">
                    <label for="company_name" class="form-label">Company Name</label>
                    {{ form.company_name(class="form-control", placeholder="Your Company Name") }}
                    {% if form.company_name.errors %}
                    <div class="text-danger">
                        {% for error in form.company_name.errors %}
                        <small>{{ error }}</small>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <div class="form-text">This will be used for caller ID and voicemail greetings</div>
                </div>
                
                <!-- Extension Settings -->
                <h5 class="mt-4 mb-3"><i class="fas fa-phone me-2"></i>Extensions</h5>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="extension_prefix" class="form-label">Extension Prefix</label>
                        {{ form.extension_prefix(class="form-control") }}
                        {% if form.extension_prefix.errors %}
                        <div class="text-danger">
                            {% for error in form.extension_prefix.errors %}
                            <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                        {% endif %}
                        <div class="form-text">Usually 10, 20, etc. Will be followed by extension number</div>
                    </div>
                    <div class="col-md-6">
                        <label for="num_extensions" class="form-label">Number of Extensions</label>
                        {{ form.num_extensions(class="form-control", min="0", max="20", oninput="updateExtensionPreview()") }}
                        {% if form.num_extensions.errors %}
                        <div class="text-danger">
                            {% for error in form.num_extensions.errors %}
                            <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                        {% endif %}
                        <div class="form-text">How many phone extensions you need</div>
                    </div>
                </div>
                
                <!-- Extension Preview -->
                <div class="extension-preview">
                    <h6><i class="fas fa-list me-2"></i>Extensions Preview</h6>
                    <div id="extension-preview-list">
                        <!-- Will be populated dynamically -->
                    </div>
                    <small class="text-muted">Extensions will be automatically created with secure passwords</small>
                </div>
                
                <!-- Trunk Settings -->
                <h5 class="mt-4 mb-3"><i class="fas fa-exchange-alt me-2"></i>SIP Trunk (External Line)</h5>
                
                <div class="mb-3 form-check form-switch">
                    {{ form.trunk_enabled(class="form-check-input", id="trunk_enabled") }}
                    <label class="form-check-label" for="trunk_enabled">Enable SIP Trunk</label>
                    <div class="form-text">Connect to an external VoIP provider for making/receiving outside calls</div>
                </div>
                
                <div id="trunk-settings">
                    <div class="mb-3">
                        <label for="trunk_provider" class="form-label">Trunk Provider</label>
                        {{ form.trunk_provider(class="form-control", placeholder="e.g. Twilio, Vonage, etc.") }}
                        {% if form.trunk_provider.errors %}
                        <div class="text-danger">
                            {% for error in form.trunk_provider.errors %}
                            <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="trunk_username" class="form-label">SIP Username</label>
                            {{ form.trunk_username(class="form-control", placeholder="Username from your provider") }}
                            {% if form.trunk_username.errors %}
                            <div class="text-danger">
                                {% for error in form.trunk_username.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="trunk_password" class="form-label">SIP Password</label>
                            {{ form.trunk_password(class="form-control", placeholder="Password from your provider") }}
                            {% if form.trunk_password.errors %}
                            <div class="text-danger">
                                {% for error in form.trunk_password.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="trunk_server" class="form-label">SIP Server</label>
                        {{ form.trunk_server(class="form-control", placeholder="e.g. sip.provider.com") }}
                        {% if form.trunk_server.errors %}
                        <div class="text-danger">
                            {% for error in form.trunk_server.errors %}
                            <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Navigation Buttons -->
            <div class="wizard-nav-buttons">
                <button type="button" class="btn btn-secondary" id="prev-step">
                    <i class="fas fa-arrow-left me-1"></i> Back
                </button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-check me-1"></i> Finish Setup
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/wizard.js') }}"></script>
<script>
    // Function to update extension preview
    function updateExtensionPreview() {
        const numExtensions = document.getElementById('num_extensions').value;
        const prefix = document.getElementById('extension_prefix').value || '10';
        const previewContainer = document.getElementById('extension-preview-list');
        
        previewContainer.innerHTML = '';
        
        if (numExtensions > 0) {
            for (let i = 1; i <= numExtensions; i++) {
                const extNumber = prefix + (i < 10 ? '0' + i : i);
                const item = document.createElement('div');
                item.className = 'extension-item';
                item.innerHTML = `
                    <div>
                        <strong>${extNumber}</strong> - Extension ${i}
                    </div>
                    <div class="text-muted">
                        <small>Voicemail PIN: ${String(i).padStart(4, '0')}</small>
                    </div>
                `;
                previewContainer.appendChild(item);
            }
        } else {
            previewContainer.innerHTML = '<p class="text-muted">No extensions will be created</p>';
        }
    }
    
    // Initialize the extension preview on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateExtensionPreview();
        
        // Update preview when prefix changes
        document.getElementById('extension_prefix').addEventListener('input', updateExtensionPreview);
    });
</script>
{% endblock %}
