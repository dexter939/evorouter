{% extends "layout.html" %}

{% block title %}Diagnostica Avanzata - Banana Pi BPI-R4 Router OS{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
        <h2>Diagnostica Avanzata</h2>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('system.diagnostics') }}" class="btn btn-sm btn-outline-primary me-2">
                <i data-feather="tool"></i> Strumenti Base
            </a>
            <a href="{{ url_for('system.index') }}" class="btn btn-sm btn-outline-secondary">
                <i data-feather="arrow-left"></i> Torna al Sistema
            </a>
        </div>
    </div>

    <!-- Tabs di navigazione -->
    <ul class="nav nav-tabs mb-4" id="diagnosticsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="network-tab" data-bs-toggle="tab" data-bs-target="#network" type="button" role="tab" aria-controls="network" aria-selected="true">
                <i data-feather="wifi" class="me-2"></i> Connettività e Rete
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="internet-tab" data-bs-toggle="tab" data-bs-target="#internet" type="button" role="tab" aria-controls="internet" aria-selected="false">
                <i data-feather="globe" class="me-2"></i> Stato Internet
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="lan-tab" data-bs-toggle="tab" data-bs-target="#lan" type="button" role="tab" aria-controls="lan" aria-selected="false">
                <i data-feather="layout" class="me-2"></i> Rete Locale LAN
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="router-tab" data-bs-toggle="tab" data-bs-target="#router" type="button" role="tab" aria-controls="router" aria-selected="false">
                <i data-feather="server" class="me-2"></i> Impostazioni Router
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab" aria-controls="advanced" aria-selected="false">
                <i data-feather="cpu" class="me-2"></i> Strumenti Avanzati
            </button>
        </li>
    </ul>

    <!-- Contenuto dei Tab -->
    <div class="tab-content" id="diagnosticsTabContent">
        <!-- Test di connettività e rete -->
        <div class="tab-pane fade show active" id="network" role="tabpanel" aria-labelledby="network-tab">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Test di Ping</h5>
                            <button type="button" class="btn btn-sm btn-primary run-test" data-test="ping">
                                <i data-feather="play-circle"></i> Esegui Test
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Host da testare</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="pingHost" value="8.8.8.8" placeholder="Inserisci un hostname o IP">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">Presets</button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item ping-preset" href="#" data-host="8.8.8.8">Google DNS (8.8.8.8)</a></li>
                                        <li><a class="dropdown-item ping-preset" href="#" data-host="1.1.1.1">Cloudflare DNS (1.1.1.1)</a></li>
                                        <li><a class="dropdown-item ping-preset" href="#" data-host="google.com">Google.com</a></li>
                                        <li><a class="dropdown-item ping-preset" href="#" data-host="192.168.1.1">Gateway Locale</a></li>
                                    </ul>
                                </div>
                                <div class="form-text">Scegli un host o inserisci un indirizzo IP per verificare la connettività di base.</div>
                            </div>
                            <div class="mb-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Numero pacchetti</label>
                                        <input type="number" class="form-control" id="pingCount" min="1" max="50" value="5">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Dimensione pacchetto</label>
                                        <select class="form-select" id="pingSize">
                                            <option value="56">Normale (56 bytes)</option>
                                            <option value="1472">Grande (1472 bytes)</option>
                                            <option value="2048">Molto grande (2048 bytes)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="results-area" id="pingResults">
                                <div class="text-muted text-center py-4">
                                    <i data-feather="send" class="mb-2" style="width: 36px; height: 36px;"></i>
                                    <p>Clicca "Esegui Test" per iniziare il test di ping.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Traceroute</h5>
                            <button type="button" class="btn btn-sm btn-primary run-test" data-test="traceroute">
                                <i data-feather="play-circle"></i> Esegui Test
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Host di destinazione</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="tracerouteHost" value="google.com" placeholder="Inserisci un hostname o IP">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">Presets</button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item traceroute-preset" href="#" data-host="google.com">Google.com</a></li>
                                        <li><a class="dropdown-item traceroute-preset" href="#" data-host="facebook.com">Facebook.com</a></li>
                                        <li><a class="dropdown-item traceroute-preset" href="#" data-host="amazon.com">Amazon.com</a></li>
                                        <li><a class="dropdown-item traceroute-preset" href="#" data-host="1.1.1.1">Cloudflare (1.1.1.1)</a></li>
                                    </ul>
                                </div>
                                <div class="form-text">Visualizza il percorso dei pacchetti verso la destinazione.</div>
                            </div>
                            <div class="mb-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Max hop</label>
                                        <input type="number" class="form-control" id="tracerouteMaxHop" min="5" max="30" value="20">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Opzioni</label>
                                        <select class="form-select" id="tracerouteOptions">
                                            <option value="standard">Standard</option>
                                            <option value="icmp">ICMP</option>
                                            <option value="tcp">TCP</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="results-area" id="tracerouteResults">
                                <div class="text-muted text-center py-4">
                                    <i data-feather="map" class="mb-2" style="width: 36px; height: 36px;"></i>
                                    <p>Clicca "Esegui Test" per visualizzare il percorso di rete.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-12 mb-4">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Test di Latenza e Perdita di Pacchetti</h5>
                            <button type="button" class="btn btn-sm btn-primary run-test" data-test="packetloss">
                                <i data-feather="play-circle"></i> Esegui Test
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Server per il test</label>
                                    <select class="form-select" id="packetlossServer">
                                        <option value="8.8.8.8">Google DNS (8.8.8.8)</option>
                                        <option value="1.1.1.1">Cloudflare (1.1.1.1)</option>
                                        <option value="208.67.222.222">OpenDNS (208.67.222.222)</option>
                                        <option value="custom">Personalizzato</option>
                                    </select>
                                </div>
                                <div class="col-md-3" id="customServerField" style="display: none;">
                                    <label class="form-label">Server personalizzato</label>
                                    <input type="text" class="form-control" id="customServer" placeholder="Inserisci IP o hostname">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Durata test (secondi)</label>
                                    <input type="number" class="form-control" id="packetlossDuration" min="5" max="300" value="30">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Intervallo (ms)</label>
                                    <input type="number" class="form-control" id="packetlossInterval" min="100" max="2000" value="500" step="100">
                                </div>
                            </div>
                            
                            <div class="progress mb-3" id="packetlossProgress" style="display: none;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="results-area" id="packetlossResults">
                                        <div class="text-muted text-center py-4">
                                            <i data-feather="activity" class="mb-2" style="width: 36px; height: 36px;"></i>
                                            <p>Clicca "Esegui Test" per analizzare la qualità della connessione.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div id="packetlossSummary" class="d-none">
                                        <div class="card border-0 bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title">Riepilogo Test</h6>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold mb-1">Latenza media:</label>
                                                    <div class="d-flex align-items-center">
                                                        <span id="avgLatency">-- ms</span>
                                                        <div class="quality-indicator ms-2" id="latencyQuality"></div>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold mb-1">Variazione latenza (jitter):</label>
                                                    <div class="d-flex align-items-center">
                                                        <span id="jitterValue">-- ms</span>
                                                        <div class="quality-indicator ms-2" id="jitterQuality"></div>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold mb-1">Perdita di pacchetti:</label>
                                                    <div class="d-flex align-items-center">
                                                        <span id="packetLossValue">--%</span>
                                                        <div class="quality-indicator ms-2" id="packetLossQuality"></div>
                                                    </div>
                                                </div>
                                                <div class="alert alert-primary mt-3 mb-0" id="connectionQuality">
                                                    <i data-feather="info" class="me-2"></i>
                                                    <span>Esegui il test per vedere la qualità</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stato della connessione internet -->
        <div class="tab-pane fade" id="internet" role="tabpanel" aria-labelledby="internet-tab">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Stato Connessione WAN</h5>
                            <button type="button" class="btn btn-sm btn-primary run-test" data-test="wan-status">
                                <i data-feather="refresh-cw"></i> Aggiorna
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="wan-status-loading text-center p-4" style="display: none;">
                                <div class="spinner-border text-primary mb-3" role="status"></div>
                                <p>Controllo dello stato WAN in corso...</p>
                            </div>
                            
                            <div id="wanStatusInfo">
                                <div class="mb-3">
                                    <div class="d-flex align-items-center mb-1">
                                        <h6 class="mb-0 me-2">Connessione Internet</h6>
                                        <div id="wanConnectionStatus" class="status-indicator"></div>
                                    </div>
                                    <p class="text-muted small mb-0" id="wanConnectionDesc">Verifica in corso...</p>
                                </div>
                                
                                <hr>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="fw-bold d-block">Interfaccia WAN</label>
                                            <span id="wanInterface">--</span>
                                        </div>
                                        <div class="mb-3">
                                            <label class="fw-bold d-block">IP Pubblico</label>
                                            <span id="publicIp">--</span>
                                        </div>
                                        <div class="mb-3">
                                            <label class="fw-bold d-block">Gateway</label>
                                            <span id="wanGateway">--</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="fw-bold d-block">Server DNS</label>
                                            <span id="dnsServers">--</span>
                                        </div>
                                        <div class="mb-3">
                                            <label class="fw-bold d-block">Tipo Connessione</label>
                                            <span id="wanType">--</span>
                                        </div>
                                        <div class="mb-3">
                                            <label class="fw-bold d-block">Uptime</label>
                                            <span id="wanUptime">--</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Test di Velocità</h5>
                            <button type="button" class="btn btn-sm btn-primary run-test" data-test="speedtest">
                                <i data-feather="play-circle"></i> Avvia Speedtest
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="speedtest-options mb-3">
                                <label class="form-label">Server per il test</label>
                                <select class="form-select" id="speedtestServer">
                                    <option value="auto">Automatico (server più vicino)</option>
                                    <option value="eu">Europa</option>
                                    <option value="us">Stati Uniti</option>
                                    <option value="asia">Asia</option>
                                </select>
                                <div class="form-text">Il test di velocità misura download, upload e latenza della tua connessione.</div>
                            </div>
                            
                            <div class="speedtest-running" style="display: none;">
                                <div class="text-center mb-3">
                                    <div class="spinner-border text-primary mb-3" role="status"></div>
                                    <p id="speedtestStatusText">Inizializzazione test...</p>
                                </div>
                                
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-primary" id="speedtestProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                            
                            <div class="speedtest-results text-center" style="display: none;">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card border-0 bg-light mb-3">
                                            <div class="card-body py-3">
                                                <h6 class="text-muted">Download</h6>
                                                <h3 id="downloadSpeed">-- Mbps</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card border-0 bg-light mb-3">
                                            <div class="card-body py-3">
                                                <h6 class="text-muted">Upload</h6>
                                                <h3 id="uploadSpeed">-- Mbps</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card border-0 bg-light mb-3">
                                            <div class="card-body py-3">
                                                <h6 class="text-muted">Ping</h6>
                                                <h3 id="pingValue">-- ms</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="speedtestDetails" class="text-start mt-3">
                                    <table class="table table-sm">
                                        <tbody>
                                            <tr>
                                                <th style="width: 40%">Server</th>
                                                <td id="speedtestServerInfo">--</td>
                                            </tr>
                                            <tr>
                                                <th>ISP</th>
                                                <td id="speedtestIsp">--</td>
                                            </tr>
                                            <tr>
                                                <th>Data test</th>
                                                <td id="speedtestDate">--</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="speedtest-error alert alert-danger" style="display: none;">
                                <i data-feather="alert-triangle" class="me-2"></i>
                                <span id="speedtestErrorMessage"></span>
                            </div>
                            
                            <div class="speedtest-waiting text-center py-4">
                                <i data-feather="zap" style="width: 48px; height: 48px;" class="text-muted mb-3"></i>
                                <p>Clicca "Avvia Speedtest" per misurare la velocità della tua connessione.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Verifica DNS e Indirizzo Pubblico</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-0 bg-light mb-3">
                                        <div class="card-body">
                                            <h6>Risoluzione DNS</h6>
                                            <div class="input-group mb-3">
                                                <input type="text" class="form-control" id="dnsDomain" placeholder="Inserisci dominio (es. google.com)">
                                                <button class="btn btn-primary run-test" type="button" data-test="dns-lookup">Risolvi</button>
                                            </div>
                                            
                                            <div id="dnsLookupResults" class="results-area">
                                                <div class="text-muted small">
                                                    Inserisci un dominio e clicca "Risolvi" per testare la risoluzione DNS.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card border-0 bg-light mb-3">
                                        <div class="card-body">
                                            <h6>Informazioni IP Pubblico</h6>
                                            <button class="btn btn-primary btn-sm mb-3 run-test" type="button" data-test="public-ip">
                                                <i data-feather="refresh-cw" class="me-1"></i> Aggiorna Informazioni
                                            </button>
                                            
                                            <div id="publicIpResults">
                                                <div class="d-flex align-items-center mb-2">
                                                    <span class="fw-bold me-2" style="width: 120px;">IP Pubblico:</span>
                                                    <span id="pubIpAddress">--</span>
                                                </div>
                                                <div class="d-flex align-items-center mb-2">
                                                    <span class="fw-bold me-2" style="width: 120px;">Localizzazione:</span>
                                                    <span id="pubIpLocation">--</span>
                                                </div>
                                                <div class="d-flex align-items-center mb-2">
                                                    <span class="fw-bold me-2" style="width: 120px;">ISP:</span>
                                                    <span id="pubIpIsp">--</span>
                                                </div>
                                                <div class="d-flex align-items-center mb-2">
                                                    <span class="fw-bold me-2" style="width: 120px;">Tipo:</span>
                                                    <span id="pubIpType">--</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Diagnostica della rete locale LAN -->
        <div class="tab-pane fade" id="lan" role="tabpanel" aria-labelledby="lan-tab">
            <div class="row">
                <div class="col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Dispositivi Connessi alla Rete</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary me-2" id="toggleOfflineDevices">
                                    <i data-feather="eye"></i> Mostra Offline
                                </button>
                                <button class="btn btn-sm btn-primary run-test" data-test="connected-devices">
                                    <i data-feather="refresh-cw"></i> Aggiorna
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="connectedDevicesTable">
                                    <thead>
                                        <tr>
                                            <th>Dispositivo</th>
                                            <th>Indirizzo IP</th>
                                            <th>Indirizzo MAC</th>
                                            <th>Interfaccia</th>
                                            <th>Connessione</th>
                                            <th>Stato</th>
                                            <th>Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody id="connectedDevicesList">
                                        <tr>
                                            <td colspan="7" class="text-center py-4">
                                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                                Ricerca dispositivi in corso...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="devices-info text-muted small mt-2">
                                <i data-feather="info" class="me-1"></i> 
                                Vengono mostrati sia i dispositivi attualmente connessi che quelli conosciuti. 
                                Dispositivi con stato "Online" sono attualmente connessi alla rete.
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Stato Interfacce LAN</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <button class="btn btn-primary btn-sm run-test" data-test="lan-interfaces">
                                    <i data-feather="refresh-cw" class="me-1"></i> Aggiorna Stato
                                </button>
                            </div>
                            
                            <div id="lanInterfacesStatus">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2">Caricamento stato interfacce...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Monitor Utilizzo Banda</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Interfaccia</label>
                                <select class="form-select" id="bandwidthInterface">
                                    <option value="all">Tutte le interfacce</option>
                                    <option value="eth0">LAN (eth0)</option>
                                    <option value="wlan0">WiFi (wlan0)</option>
                                    <option value="eth1">WAN (eth1)</option>
                                </select>
                            </div>
                            
                            <div class="chart-container" style="position: relative; height: 250px;">
                                <canvas id="bandwidthChart"></canvas>
                            </div>
                            
                            <div class="row text-center mt-3">
                                <div class="col-6">
                                    <div class="card bg-light border-0">
                                        <div class="card-body py-2">
                                            <h6 class="text-muted mb-1">Download</h6>
                                            <h4 id="currentDownload">0 Mbps</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card bg-light border-0">
                                        <div class="card-body py-2">
                                            <h6 class="text-muted mb-1">Upload</h6>
                                            <h4 id="currentUpload">0 Mbps</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Verifica delle impostazioni del router -->
        <div class="tab-pane fade" id="router" role="tabpanel" aria-labelledby="router-tab">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Stato Firewall e NAT</h5>
                            <button type="button" class="btn btn-sm btn-primary run-test" data-test="firewall-status">
                                <i data-feather="refresh-cw"></i> Aggiorna
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="firewall-status-area">
                                <div class="mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">Stato Firewall</h6>
                                        <div id="firewallState" class="status-indicator"></div>
                                    </div>
                                    <p class="mb-0 text-muted small">Il firewall protegge la tua rete da accessi non autorizzati.</p>
                                </div>
                                
                                <hr>
                                
                                <h6 class="mb-3">Regole Attive</h6>
                                <div class="table-responsive" id="firewallRulesArea">
                                    <table class="table table-sm" id="firewallRulesTable">
                                        <thead>
                                            <tr>
                                                <th>Tipo</th>
                                                <th>Interfaccia</th>
                                                <th>Porta/Protocollo</th>
                                                <th>Azione</th>
                                            </tr>
                                        </thead>
                                        <tbody id="firewallRulesList">
                                            <tr>
                                                <td colspan="4" class="text-center">
                                                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                                    Caricamento regole...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <hr>
                                
                                <h6 class="mb-3">Port Forwarding</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm" id="portForwardingTable">
                                        <thead>
                                            <tr>
                                                <th>Nome</th>
                                                <th>Porta Esterna</th>
                                                <th>IP Interno</th>
                                                <th>Porta Interna</th>
                                                <th>Protocollo</th>
                                            </tr>
                                        </thead>
                                        <tbody id="portForwardingList">
                                            <tr>
                                                <td colspan="5" class="text-center">
                                                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                                    Caricamento regole...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Test Porte</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Verifica di una porta specifica</label>
                                <div class="row g-2">
                                    <div class="col-md-8">
                                        <input type="number" class="form-control" id="portToCheck" min="1" max="65535" placeholder="Inserisci numero porta (1-65535)">
                                    </div>
                                    <div class="col-md-4">
                                        <select class="form-select" id="portProtocol">
                                            <option value="tcp">TCP</option>
                                            <option value="udp">UDP</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-text">Verifica se una porta specifica è aperta esternamente.</div>
                            </div>
                            
                            <div class="mb-3">
                                <button type="button" class="btn btn-primary run-test" data-test="port-check">
                                    <i data-feather="search"></i> Verifica Porta
                                </button>
                            </div>
                            
                            <div id="portCheckResults" class="results-area">
                                <div class="text-muted text-center py-3">
                                    <i data-feather="shield" class="mb-2" style="width: 36px; height: 36px;"></i>
                                    <p>Inserisci una porta e clicca "Verifica Porta" per controllare se è aperta.</p>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <h6 class="mb-3">Verifica Porte Comuni</h6>
                            <div class="row">
                                <div class="col-md-4 mb-2">
                                    <button class="btn btn-outline-secondary btn-sm w-100 common-port" data-port="80" data-protocol="tcp">
                                        HTTP (80)
                                    </button>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <button class="btn btn-outline-secondary btn-sm w-100 common-port" data-port="443" data-protocol="tcp">
                                        HTTPS (443)
                                    </button>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <button class="btn btn-outline-secondary btn-sm w-100 common-port" data-port="22" data-protocol="tcp">
                                        SSH (22)
                                    </button>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <button class="btn btn-outline-secondary btn-sm w-100 common-port" data-port="21" data-protocol="tcp">
                                        FTP (21)
                                    </button>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <button class="btn btn-outline-secondary btn-sm w-100 common-port" data-port="3389" data-protocol="tcp">
                                        RDP (3389)
                                    </button>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <button class="btn btn-outline-secondary btn-sm w-100 common-port" data-port="1194" data-protocol="udp">
                                        OpenVPN (1194)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Log di Sistema</h5>
                            <div>
                                <select class="form-select form-select-sm d-inline-block w-auto me-2" id="logType">
                                    <option value="all">Tutti i log</option>
                                    <option value="system">Sistema</option>
                                    <option value="network">Rete</option>
                                    <option value="security">Sicurezza</option>
                                    <option value="firewall">Firewall</option>
                                </select>
                                <button class="btn btn-sm btn-primary run-test" data-test="system-logs">
                                    <i data-feather="refresh-cw"></i> Aggiorna
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm" id="systemLogsTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 180px;">Data/Ora</th>
                                            <th style="width: 100px;">Tipo</th>
                                            <th style="width: 100px;">Livello</th>
                                            <th>Messaggio</th>
                                        </tr>
                                    </thead>
                                    <tbody id="systemLogsList">
                                        <tr>
                                            <td colspan="4" class="text-center py-3">
                                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                                Caricamento log...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-2">
                                <a href="{{ url_for('system.logs') }}" class="btn btn-sm btn-outline-primary">
                                    <i data-feather="external-link" class="me-1"></i> Visualizza tutti i log
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strumenti avanzati -->
        <div class="tab-pane fade" id="advanced" role="tabpanel" aria-labelledby="advanced-tab">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Quality of Service (QoS)</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="qosEnabled" checked>
                                    <label class="form-check-label" for="qosEnabled">QoS Abilitato</label>
                                </div>
                                <div class="form-text">La Quality of Service gestisce la priorità del traffico sulla rete.</div>
                            </div>
                            
                            <div id="qosStatusInfo">
                                <div class="mb-3">
                                    <button type="button" class="btn btn-primary btn-sm run-test" data-test="qos-status">
                                        <i data-feather="bar-chart-2" class="me-1"></i> Verifica Stato QoS
                                    </button>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Tipo Traffico</th>
                                                <th>Priorità</th>
                                                <th>Banda Allocata</th>
                                                <th>Stato</th>
                                            </tr>
                                        </thead>
                                        <tbody id="qosRulesList">
                                            <tr>
                                                <td>Voce (VoIP)</td>
                                                <td><span class="badge bg-danger">Alta</span></td>
                                                <td>20%</td>
                                                <td><span class="badge bg-success">Attivo</span></td>
                                            </tr>
                                            <tr>
                                                <td>Video</td>
                                                <td><span class="badge bg-warning">Media</span></td>
                                                <td>30%</td>
                                                <td><span class="badge bg-success">Attivo</span></td>
                                            </tr>
                                            <tr>
                                                <td>Navigazione</td>
                                                <td><span class="badge bg-warning">Media</span></td>
                                                <td>30%</td>
                                                <td><span class="badge bg-success">Attivo</span></td>
                                            </tr>
                                            <tr>
                                                <td>Download</td>
                                                <td><span class="badge bg-secondary">Bassa</span></td>
                                                <td>20%</td>
                                                <td><span class="badge bg-success">Attivo</span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Diagnostica VoIP</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <p>Verifica la qualità della tua connessione per chiamate VoIP.</p>
                                <button type="button" class="btn btn-primary btn-sm run-test" data-test="voip-test">
                                    <i data-feather="phone" class="me-1"></i> Esegui Test VoIP
                                </button>
                            </div>
                            
                            <div id="voipTestResults" class="results-area">
                                <div class="text-muted text-center py-3">
                                    <i data-feather="phone" class="mb-2" style="width: 36px; height: 36px;"></i>
                                    <p>Clicca "Esegui Test VoIP" per verificare la qualità della voce sulla tua rete.</p>
                                </div>
                            </div>
                            
                            <div id="voipQualitySummary" class="mt-3 d-none">
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <h6>Riepilogo Qualità VoIP</h6>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>Punteggio MOS:</span>
                                            <span id="mosScore" class="fw-bold">4.2</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>Latenza:</span>
                                            <span id="voipLatency" class="fw-bold">25 ms</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>Jitter:</span>
                                            <span id="voipJitter" class="fw-bold">4 ms</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>Perdita pacchetti:</span>
                                            <span id="voipPacketLoss" class="fw-bold">0.2%</span>
                                        </div>
                                        <hr>
                                        <div class="alert alert-success mb-0">
                                            <i data-feather="check-circle" class="me-2"></i>
                                            <span id="voipQualityVerdict">Eccellente qualità per chiamate VoIP</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Test VPN</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <h6>Stato Server VPN</h6>
                                        <p class="text-muted">Verifica lo stato del server VPN e diagnostica eventuali problemi.</p>
                                        <button type="button" class="btn btn-primary btn-sm run-test" data-test="vpn-server-status">
                                            <i data-feather="shield" class="me-1"></i> Verifica Server VPN
                                        </button>
                                    </div>
                                    
                                    <div id="vpnServerResults" class="results-area mb-3">
                                        <div class="text-muted py-3">
                                            <p>Clicca "Verifica Server VPN" per controllare lo stato del server.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <h6>Test Connessione Client VPN</h6>
                                        <p class="text-muted">Verifica le prestazioni e la connettività di client VPN connessi.</p>
                                        <div class="input-group mb-3">
                                            <select class="form-select" id="vpnClientToTest">
                                                <option value="">Seleziona client...</option>
                                                <option value="client1">Client1</option>
                                                <option value="client2">Client2</option>
                                                <option value="client3">Client3</option>
                                            </select>
                                            <button class="btn btn-primary run-test" type="button" data-test="vpn-client-test">Testa</button>
                                        </div>
                                    </div>
                                    
                                    <div id="vpnClientResults" class="results-area">
                                        <div class="text-muted py-3">
                                            <p>Seleziona un client VPN e clicca "Testa" per verificarne lo stato.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div class="row">
                                <div class="col-md-12">
                                    <h6>Routing Traffico VPN</h6>
                                    <p class="text-muted mb-3">
                                        Verifica come viene instradato il traffico attraverso la tua connessione VPN.
                                    </p>
                                    
                                    <div class="d-flex mb-3">
                                        <button type="button" class="btn btn-primary btn-sm me-2 run-test" data-test="vpn-routing">
                                            <i data-feather="map" class="me-1"></i> Analizza Routing VPN
                                        </button>
                                        
                                        <div class="form-check form-switch ms-3 d-flex align-items-center">
                                            <input class="form-check-input me-2" type="checkbox" id="splitTunnelingEnabled">
                                            <label class="form-check-label" for="splitTunnelingEnabled">Split Tunneling</label>
                                        </div>
                                    </div>
                                    
                                    <div id="vpnRoutingResults" class="results-area">
                                        <div class="text-muted py-3">
                                            <p>Clicca "Analizza Routing VPN" per verificare il percorso del traffico.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}

.status-indicator.status-green {
    background-color: #28a745;
}

.status-indicator.status-red {
    background-color: #dc3545;
}

.status-indicator.status-yellow {
    background-color: #ffc107;
}

.status-indicator.status-gray {
    background-color: #6c757d;
}

.results-area {
    background-color: #f8f9fa;
    border-radius: 4px;
    min-height: 100px;
    padding: 10px;
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 0.9rem;
}

.tool-description p {
    margin-bottom: 0.5rem;
}

.quality-indicator {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: inline-block;
}

.quality-indicator.quality-excellent {
    background-color: #28a745;
}

.quality-indicator.quality-good {
    background-color: #17a2b8;
}

.quality-indicator.quality-fair {
    background-color: #ffc107;
}

.quality-indicator.quality-poor {
    background-color: #dc3545;
}

.chart-container {
    position: relative;
    height: 250px;
    margin-bottom: 20px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Chart.js configuration
let bandwidthChart = null;

document.addEventListener('DOMContentLoaded', function() {
    // Inizializzazione Chart.js per il monitor di banda
    const ctx = document.getElementById('bandwidthChart').getContext('2d');
    
    bandwidthChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array(30).fill(''),
            datasets: [
                {
                    label: 'Download',
                    data: Array(30).fill(0),
                    borderColor: 'rgba(0, 123, 255, 1)',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Upload',
                    data: Array(30).fill(0),
                    borderColor: 'rgba(40, 167, 69, 1)',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Mbps'
                    }
                }
            },
            animation: {
                duration: 0
            }
        }
    });
    
    // Simulazione dati in tempo reale
    setInterval(updateBandwidthData, 1000);
    
    // Event listeners per i test diagnostici
    document.querySelectorAll('.run-test').forEach(button => {
        button.addEventListener('click', function() {
            const testType = this.getAttribute('data-test');
            runDiagnosticTest(testType);
        });
    });
    
    // Gestione delle schede comuni per il test delle porte
    document.querySelectorAll('.common-port').forEach(button => {
        button.addEventListener('click', function() {
            const port = this.getAttribute('data-port');
            const protocol = this.getAttribute('data-protocol');
            
            document.getElementById('portToCheck').value = port;
            document.getElementById('portProtocol').value = protocol;
            
            // Trova e clicca il pulsante di test porte
            document.querySelector('[data-test="port-check"]').click();
        });
    });
    
    // Gestione scelta server personalizzato per test packetloss
    document.getElementById('packetlossServer').addEventListener('change', function() {
        if (this.value === 'custom') {
            document.getElementById('customServerField').style.display = 'block';
        } else {
            document.getElementById('customServerField').style.display = 'none';
        }
    });
    
    // Presets per ping
    document.querySelectorAll('.ping-preset').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('pingHost').value = this.getAttribute('data-host');
        });
    });
    
    // Presets per traceroute
    document.querySelectorAll('.traceroute-preset').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('tracerouteHost').value = this.getAttribute('data-host');
        });
    });
    
    // Toggle per dispositivi offline
    document.getElementById('toggleOfflineDevices').addEventListener('click', function() {
        const offlineDevices = document.querySelectorAll('.device-offline');
        const isHidden = offlineDevices.length > 0 && offlineDevices[0].style.display === 'none';
        
        offlineDevices.forEach(device => {
            device.style.display = isHidden ? 'table-row' : 'none';
        });
        
        // Aggiorna il testo del pulsante
        const icon = this.querySelector('i');
        if (isHidden) {
            icon.setAttribute('data-feather', 'eye-off');
            this.innerHTML = '<i data-feather="eye-off"></i> Nascondi Offline';
        } else {
            icon.setAttribute('data-feather', 'eye');
            this.innerHTML = '<i data-feather="eye"></i> Mostra Offline';
        }
        feather.replace();
    });
    
    // Popola la tabella dei dispositivi connessi (simulato)
    populateConnectedDevices();
    
    // Esegui test WAN all'avvio
    setTimeout(() => {
        document.querySelector('[data-test="wan-status"]').click();
    }, 500);
});

// Funzione di simulazione per test diagnostici
function runDiagnosticTest(testType) {
    console.log('Running diagnostic test:', testType);
    
    switch(testType) {
        case 'ping':
            runPingTest();
            break;
        case 'traceroute':
            runTracerouteTest();
            break;
        case 'packetloss':
            runPacketLossTest();
            break;
        case 'wan-status':
            updateWanStatus();
            break;
        case 'speedtest':
            runSpeedTest();
            break;
        case 'dns-lookup':
            runDnsLookup();
            break;
        case 'public-ip':
            updatePublicIpInfo();
            break;
        case 'connected-devices':
            populateConnectedDevices();
            break;
        case 'lan-interfaces':
            updateLanInterfaces();
            break;
        case 'firewall-status':
            updateFirewallStatus();
            break;
        case 'port-check':
            checkPort();
            break;
        case 'system-logs':
            loadSystemLogs();
            break;
        case 'qos-status':
            checkQosStatus();
            break;
        case 'voip-test':
            testVoipQuality();
            break;
        case 'vpn-server-status':
            checkVpnServerStatus();
            break;
        case 'vpn-client-test':
            testVpnClient();
            break;
        case 'vpn-routing':
            analyzeVpnRouting();
            break;
    }
}

// Simulazione di un test ping
function runPingTest() {
    const host = document.getElementById('pingHost').value;
    const count = document.getElementById('pingCount').value;
    const size = document.getElementById('pingSize').value;
    
    if (!host) {
        document.getElementById('pingResults').innerHTML = '<div class="alert alert-danger">Errore: Inserire un host valido.</div>';
        return;
    }
    
    const resultsArea = document.getElementById('pingResults');
    resultsArea.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Esecuzione ping in corso...</p></div>';
    
    // Simula una richiesta ping
    setTimeout(() => {
        // Simula risposta ping
        const pingTime = Math.floor(Math.random() * 50) + 10;
        const pingResults = `PING ${host} (${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}) ${size}(${parseInt(size) + 28}) bytes of data.
64 bytes from ${host}: icmp_seq=1 ttl=55 time=${pingTime}.1 ms
64 bytes from ${host}: icmp_seq=2 ttl=55 time=${pingTime + Math.floor(Math.random() * 5)}.3 ms
64 bytes from ${host}: icmp_seq=3 ttl=55 time=${pingTime + Math.floor(Math.random() * 5)}.7 ms
64 bytes from ${host}: icmp_seq=4 ttl=55 time=${pingTime + Math.floor(Math.random() * 5)}.2 ms
64 bytes from ${host}: icmp_seq=5 ttl=55 time=${pingTime + Math.floor(Math.random() * 5)}.8 ms

--- ${host} ping statistics ---
${count} packets transmitted, ${count} received, 0% packet loss, time ${count * 10}ms
rtt min/${pingTime}.1 avg/${pingTime + 2}.5 max/${pingTime + 5}.8 mdev/1.5 ms`;
        
        resultsArea.textContent = pingResults;
    }, 1500);
}

// Simula aggiornamento dati larghezza di banda
function updateBandwidthData() {
    if (!bandwidthChart) return;
    
    // Simula valori di larghezza di banda
    const downloadSpeed = Math.random() * 50 + 10; // Simula 10-60 Mbps
    const uploadSpeed = Math.random() * 10 + 2;   // Simula 2-12 Mbps
    
    // Aggiorna i display correnti
    document.getElementById('currentDownload').textContent = downloadSpeed.toFixed(1) + ' Mbps';
    document.getElementById('currentUpload').textContent = uploadSpeed.toFixed(1) + ' Mbps';
    
    // Aggiorna i dati del grafico
    bandwidthChart.data.datasets[0].data.shift();
    bandwidthChart.data.datasets[0].data.push(downloadSpeed);
    
    bandwidthChart.data.datasets[1].data.shift();
    bandwidthChart.data.datasets[1].data.push(uploadSpeed);
    
    bandwidthChart.update();
}

// Simulazione test traceroute
function runTracerouteTest() {
    const host = document.getElementById('tracerouteHost').value;
    const maxHop = document.getElementById('tracerouteMaxHop').value;
    
    if (!host) {
        document.getElementById('tracerouteResults').innerHTML = '<div class="alert alert-danger">Errore: Inserire un host valido.</div>';
        return;
    }
    
    const resultsArea = document.getElementById('tracerouteResults');
    resultsArea.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Esecuzione traceroute in corso...</p></div>';
    
    // Simula traceroute
    setTimeout(() => {
        let tracerouteOutput = `traceroute to ${host}, ${maxHop} hops max, 60 byte packets\n`;
        
        // Genera hop casuali
        const hopCount = Math.floor(Math.random() * 10) + 5;
        
        for (let i = 1; i <= hopCount; i++) {
            const hopTime = Math.floor(Math.random() * 50) + 5;
            const ipPrefix = `192.168.${i}.`;
            
            tracerouteOutput += `${i}  router-${i}.local (${ipPrefix}1)  ${hopTime}.${Math.floor(Math.random() * 999)} ms  ${hopTime + Math.floor(Math.random() * 5)}.${Math.floor(Math.random() * 999)} ms  ${hopTime + Math.floor(Math.random() * 5)}.${Math.floor(Math.random() * 999)} ms\n`;
        }
        
        // Simula la destinazione
        const finalHop = hopCount + 1;
        const finalTime = Math.floor(Math.random() * 30) + 40;
        tracerouteOutput += `${finalHop}  ${host} (${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)})  ${finalTime}.${Math.floor(Math.random() * 999)} ms  ${finalTime + Math.floor(Math.random() * 10)}.${Math.floor(Math.random() * 999)} ms  ${finalTime + Math.floor(Math.random() * 10)}.${Math.floor(Math.random() * 999)} ms\n`;
        
        resultsArea.textContent = tracerouteOutput;
    }, 2500);
}

// Simulazione test di perdita di pacchetti
function runPacketLossTest() {
    let server = document.getElementById('packetlossServer').value;
    if (server === 'custom') {
        server = document.getElementById('customServer').value;
        if (!server) {
            document.getElementById('packetlossResults').innerHTML = '<div class="alert alert-danger">Errore: Inserire un server personalizzato valido.</div>';
            return;
        }
    }
    
    const duration = document.getElementById('packetlossDuration').value;
    const interval = document.getElementById('packetlossInterval').value;
    
    // Mostra area risultati e barra di avanzamento
    document.getElementById('packetlossProgress').style.display = 'block';
    document.getElementById('packetlossResults').innerHTML = '<div class="text-center"><p>Test in corso verso ' + server + '...</p><p>Durata: ' + duration + ' secondi</p></div>';
    document.getElementById('packetlossSummary').classList.remove('d-none');
    
    // Simula progresso
    const progressBar = document.querySelector('#packetlossProgress .progress-bar');
    progressBar.style.width = '0%';
    progressBar.setAttribute('aria-valuenow', 0);
    
    let progress = 0;
    const totalSteps = 10;
    const intervalTime = (duration * 1000) / totalSteps;
    
    const progressInterval = setInterval(() => {
        progress += 100 / totalSteps;
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        
        if (progress >= 100) {
            clearInterval(progressInterval);
            completePacketLossTest(server);
        }
    }, intervalTime);
}

// Completa il test di perdita pacchetti con risultati simulati
function completePacketLossTest(server) {
    const avgLatency = Math.floor(Math.random() * 50) + 15;
    const jitter = Math.floor(Math.random() * 8) + 1;
    const packetLoss = Math.random() * 2; // 0-2%
    
    // Aggiorna i valori di riepilogo
    document.getElementById('avgLatency').textContent = avgLatency + ' ms';
    document.getElementById('jitterValue').textContent = jitter + ' ms';
    document.getElementById('packetLossValue').textContent = packetLoss.toFixed(1) + '%';
    
    // Imposta indicatori qualitativi
    setQualityIndicator('latencyQuality', avgLatency);
    setQualityIndicator('jitterQuality', jitter);
    setQualityIndicator('packetLossQuality', packetLoss);
    
    // Aggiorna il verdetto complessivo
    const connectionQualityAlert = document.getElementById('connectionQuality');
    let qualityVerdict = '';
    let alertClass = '';
    
    if (avgLatency < 30 && jitter < 5 && packetLoss < 0.5) {
        qualityVerdict = 'Eccellente qualità di connessione';
        alertClass = 'alert-success';
    } else if (avgLatency < 60 && jitter < 10 && packetLoss < 1) {
        qualityVerdict = 'Buona qualità di connessione';
        alertClass = 'alert-primary';
    } else if (avgLatency < 100 && jitter < 15 && packetLoss < 2) {
        qualityVerdict = 'Qualità di connessione accettabile';
        alertClass = 'alert-warning';
    } else {
        qualityVerdict = 'Qualità di connessione problematica';
        alertClass = 'alert-danger';
    }
    
    connectionQualityAlert.className = 'alert mt-3 mb-0 ' + alertClass;
    connectionQualityAlert.innerHTML = `<i data-feather="info" class="me-2"></i><span>${qualityVerdict}</span>`;
    feather.replace();
    
    // Genera dati di ping simulati
    let resultsText = `Risultati test di latenza e perdita pacchetti per ${server}:\n\n`;
    resultsText += `Test completato in ${document.getElementById('packetlossDuration').value} secondi\n`;
    resultsText += `Intervallo pacchetti: ${document.getElementById('packetlossInterval').value} ms\n\n`;
    resultsText += `Pacchetti inviati: 50\n`;
    resultsText += `Pacchetti ricevuti: ${Math.floor(50 - (50 * packetLoss / 100))}\n`;
    resultsText += `Pacchetti persi: ${Math.ceil(50 * packetLoss / 100)} (${packetLoss.toFixed(1)}%)\n\n`;
    resultsText += `Latenza minima: ${avgLatency - Math.floor(Math.random() * 10)} ms\n`;
    resultsText += `Latenza media: ${avgLatency} ms\n`;
    resultsText += `Latenza massima: ${avgLatency + Math.floor(Math.random() * 15)} ms\n`;
    resultsText += `Jitter: ${jitter} ms\n`;
    
    document.getElementById('packetlossResults').textContent = resultsText;
}

// Imposta l'indicatore di qualità in base al valore
function setQualityIndicator(elementId, value) {
    const element = document.getElementById(elementId);
    element.className = 'quality-indicator';
    
    // Diversi criteri per latenza, jitter e perdita pacchetti
    if (elementId === 'latencyQuality') {
        if (value < 30) element.classList.add('quality-excellent');
        else if (value < 60) element.classList.add('quality-good');
        else if (value < 100) element.classList.add('quality-fair');
        else element.classList.add('quality-poor');
    } else if (elementId === 'jitterQuality') {
        if (value < 5) element.classList.add('quality-excellent');
        else if (value < 10) element.classList.add('quality-good');
        else if (value < 15) element.classList.add('quality-fair');
        else element.classList.add('quality-poor');
    } else if (elementId === 'packetLossQuality') {
        if (value < 0.5) element.classList.add('quality-excellent');
        else if (value < 1) element.classList.add('quality-good');
        else if (value < 2) element.classList.add('quality-fair');
        else element.classList.add('quality-poor');
    }
}

// Aggiorna lo stato della connessione WAN
function updateWanStatus() {
    document.querySelector('.wan-status-loading').style.display = 'block';
    document.getElementById('wanStatusInfo').style.display = 'none';
    
    // Simula caricamento
    setTimeout(() => {
        document.querySelector('.wan-status-loading').style.display = 'none';
        document.getElementById('wanStatusInfo').style.display = 'block';
        
        // Simula stato connessione
        const connected = Math.random() > 0.1; // 90% di probabilità di essere connesso
        const connectionStatus = document.getElementById('wanConnectionStatus');
        const connectionDesc = document.getElementById('wanConnectionDesc');
        
        if (connected) {
            connectionStatus.className = 'status-indicator status-green';
            connectionDesc.textContent = 'Connessione Internet attiva e funzionante';
            
            // Popola altre informazioni
            document.getElementById('wanInterface').textContent = 'eth1';
            document.getElementById('publicIp').textContent = '203.0.113.' + Math.floor(Math.random() * 255);
            document.getElementById('wanGateway').textContent = '192.168.1.1';
            document.getElementById('dnsServers').textContent = '8.8.8.8, 8.8.4.4';
            document.getElementById('wanType').textContent = 'DHCP';
            
            // Calcola uptime simulato
            const hours = Math.floor(Math.random() * 48) + 1;
            const minutes = Math.floor(Math.random() * 60);
            document.getElementById('wanUptime').textContent = `${hours} ore, ${minutes} minuti`;
        } else {
            connectionStatus.className = 'status-indicator status-red';
            connectionDesc.textContent = 'Connessione Internet non disponibile';
            
            // Azzera altre informazioni
            document.getElementById('wanInterface').textContent = 'eth1 (disconnesso)';
            document.getElementById('publicIp').textContent = 'Non disponibile';
            document.getElementById('wanGateway').textContent = 'Non disponibile';
            document.getElementById('dnsServers').textContent = 'Non disponibile';
            document.getElementById('wanType').textContent = 'DHCP';
            document.getElementById('wanUptime').textContent = 'N/A';
        }
    }, 1500);
}

// Simulazione speed test
function runSpeedTest() {
    // Nascondi risultati precedenti e mostra progresso
    document.querySelector('.speedtest-waiting').style.display = 'none';
    document.querySelector('.speedtest-results').style.display = 'none';
    document.querySelector('.speedtest-error').style.display = 'none';
    document.querySelector('.speedtest-running').style.display = 'block';
    document.querySelector('.speedtest-options').style.display = 'none';
    
    const progressBar = document.getElementById('speedtestProgress');
    const statusText = document.getElementById('speedtestStatusText');
    
    // Simula le varie fasi del test
    let progress = 0;
    progressBar.style.width = '0%';
    progressBar.setAttribute('aria-valuenow', 0);
    
    statusText.textContent = 'Inizializzazione test...';
    
    setTimeout(() => {
        statusText.textContent = 'Selezione server...';
        progress = 10;
        updateSpeedtestProgress(progress);
    }, 800);
    
    setTimeout(() => {
        statusText.textContent = 'Misurazione latenza...';
        progress = 20;
        updateSpeedtestProgress(progress);
    }, 1600);
    
    setTimeout(() => {
        statusText.textContent = 'Test velocità download...';
        progress = 30;
        updateSpeedtestProgress(progress);
        
        // Simula incremento progressivo durante download
        let downloadInterval = setInterval(() => {
            progress += 5;
            updateSpeedtestProgress(progress);
            
            if (progress >= 70) {
                clearInterval(downloadInterval);
                statusText.textContent = 'Test velocità upload...';
            }
        }, 500);
    }, 2400);
    
    setTimeout(() => {
        let uploadInterval = setInterval(() => {
            progress += 5;
            updateSpeedtestProgress(progress);
            
            if (progress >= 95) {
                clearInterval(uploadInterval);
                statusText.textContent = 'Completamento test...';
            }
        }, 400);
    }, 6000);
    
    // Completa il test dopo 8 secondi
    setTimeout(() => {
        progress = 100;
        updateSpeedtestProgress(progress);
        
        // Mostra risultati
        document.querySelector('.speedtest-running').style.display = 'none';
        document.querySelector('.speedtest-results').style.display = 'block';
        
        // Generiamo risultati casuali
        const downloadSpeed = Math.floor(Math.random() * 80) + 30; // 30-110 Mbps
        const uploadSpeed = Math.floor(Math.random() * 30) + 10;   // 10-40 Mbps
        const ping = Math.floor(Math.random() * 30) + 10;          // 10-40 ms
        
        document.getElementById('downloadSpeed').textContent = downloadSpeed + ' Mbps';
        document.getElementById('uploadSpeed').textContent = uploadSpeed + ' Mbps';
        document.getElementById('pingValue').textContent = ping + ' ms';
        
        // Dettagli test
        const serverType = document.getElementById('speedtestServer').value;
        let serverInfo;
        
        switch(serverType) {
            case 'eu':
                serverInfo = 'Roma, IT (Fastweb)';
                break;
            case 'us':
                serverInfo = 'New York, US (Verizon)';
                break;
            case 'asia':
                serverInfo = 'Tokyo, JP (NTT)';
                break;
            default:
                serverInfo = 'Milano, IT (TIM)';
        }
        
        document.getElementById('speedtestServerInfo').textContent = serverInfo;
        document.getElementById('speedtestIsp').textContent = 'TIM';
        document.getElementById('speedtestDate').textContent = new Date().toLocaleString();
    }, 8000);
}

// Aggiorna la barra di avanzamento dello speed test
function updateSpeedtestProgress(value) {
    const progressBar = document.getElementById('speedtestProgress');
    progressBar.style.width = value + '%';
    progressBar.setAttribute('aria-valuenow', value);
}

// Simula lookup DNS
function runDnsLookup() {
    const domain = document.getElementById('dnsDomain').value;
    
    if (!domain) {
        document.getElementById('dnsLookupResults').innerHTML = '<div class="alert alert-danger">Errore: Inserire un dominio valido.</div>';
        return;
    }
    
    document.getElementById('dnsLookupResults').innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm text-primary" role="status"></div> Risoluzione DNS in corso...</div>';
    
    // Simula lookup
    setTimeout(() => {
        // Generiamo IP casuali
        const ipCount = Math.floor(Math.random() * 3) + 1;
        let results = `Risoluzione DNS per ${domain}:\n\n`;
        
        for (let i = 0; i < ipCount; i++) {
            const ip = `${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`;
            results += `${domain}\t\tIN\tA\t${ip}\n`;
        }
        
        results += `\nQuery completata in ${Math.floor(Math.random() * 50) + 10} ms`;
        
        document.getElementById('dnsLookupResults').textContent = results;
    }, 1200);
}

// Aggiorna informazioni IP pubblico
function updatePublicIpInfo() {
    const results = document.getElementById('publicIpResults');
    
    // Nascondi temporaneamente gli elementi esistenti
    Array.from(results.children).forEach(child => {
        child.style.opacity = 0.3;
    });
    
    // Aggiungi spinner
    const spinner = document.createElement('div');
    spinner.className = 'text-center mt-3';
    spinner.innerHTML = '<div class="spinner-border text-primary" role="status"></div><p class="mt-2">Recupero informazioni IP...</p>';
    results.appendChild(spinner);
    
    // Simula caricamento
    setTimeout(() => {
        // Rimuovi spinner
        results.removeChild(spinner);
        
        // Ripristina opacità
        Array.from(results.children).forEach(child => {
            child.style.opacity = 1;
        });
        
        // Aggiorna valori
        document.getElementById('pubIpAddress').textContent = '203.0.113.' + Math.floor(Math.random() * 255);
        document.getElementById('pubIpLocation').textContent = 'Milano, Italia';
        document.getElementById('pubIpIsp').textContent = 'TIM Telecom Italia';
        document.getElementById('pubIpType').textContent = 'Residenziale';
    }, 1500);
}

// Popola la tabella dei dispositivi connessi (simulata)
function populateConnectedDevices() {
    const tableBody = document.getElementById('connectedDevicesList');
    tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Scansione rete in corso...</p></td></tr>';
    
    // Simula scansione
    setTimeout(() => {
        // Generiamo una lista simulata di dispositivi
        const devices = [
            { name: 'Router', ip: '192.168.1.1', mac: 'AA:BB:CC:11:22:33', interface: 'LAN', connection: 'Cablata', status: 'Online' },
            { name: 'PC-Ufficio', ip: '192.168.1.2', mac: 'AA:BB:CC:11:22:34', interface: 'LAN', connection: 'Cablata', status: 'Online' },
            { name: 'Laptop-Admin', ip: '192.168.1.3', mac: 'AA:BB:CC:11:22:35', interface: 'WiFi', connection: 'Wireless', status: 'Online' },
            { name: 'Smartphone-Mario', ip: '192.168.1.4', mac: 'AA:BB:CC:11:22:36', interface: 'WiFi', connection: 'Wireless', status: 'Online' },
            { name: 'Tablet-Lucia', ip: '192.168.1.5', mac: 'AA:BB:CC:11:22:37', interface: 'WiFi', connection: 'Wireless', status: 'Online' },
            { name: 'Smart-TV-Soggiorno', ip: '192.168.1.6', mac: 'AA:BB:CC:11:22:38', interface: 'LAN', connection: 'Cablata', status: 'Online' },
            { name: 'Stampante-Ufficio', ip: '192.168.1.7', mac: 'AA:BB:CC:11:22:39', interface: 'LAN', connection: 'Cablata', status: 'Offline' },
            { name: 'Termostato-Smart', ip: '192.168.1.8', mac: 'AA:BB:CC:11:22:40', interface: 'WiFi', connection: 'Wireless', status: 'Offline' }
        ];
        
        // Costruisci la tabella
        let tableHtml = '';
        
        devices.forEach(device => {
            const statusClass = device.status === 'Online' ? 'status-green' : 'status-gray';
            const rowClass = device.status === 'Offline' ? 'device-offline' : '';
            const displayStyle = device.status === 'Offline' ? 'none' : '';
            
            tableHtml += `
            <tr class="${rowClass}" style="display: ${displayStyle}">
                <td>${device.name}</td>
                <td>${device.ip}</td>
                <td><span class="text-monospace">${device.mac}</span></td>
                <td>${device.interface}</td>
                <td>${device.connection}</td>
                <td><div class="d-flex align-items-center"><div class="status-indicator ${statusClass} me-2"></div> ${device.status}</div></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-primary" title="Ping" onclick="runDiagnosticTest('ping'); document.getElementById('pingHost').value='${device.ip}'">
                            <i data-feather="activity" style="width: 16px; height: 16px;"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" title="Dettagli">
                            <i data-feather="info" style="width: 16px; height: 16px;"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
        });
        
        tableBody.innerHTML = tableHtml;
        feather.replace();
    }, 2000);
}

// Aggiorna stato interfacce LAN
function updateLanInterfaces() {
    const statusArea = document.getElementById('lanInterfacesStatus');
    statusArea.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Caricamento stato interfacce...</p></div>';
    
    // Simula caricamento
    setTimeout(() => {
        // Interfacce simulate
        const interfaces = [
            { name: 'eth0', type: 'LAN', state: 'UP', speed: '1 Gbps', ip: '192.168.1.1', mac: 'AA:BB:CC:11:22:33' },
            { name: 'eth1', type: 'WAN', state: 'UP', speed: '1 Gbps', ip: '203.0.113.10', mac: 'AA:BB:CC:11:22:34' },
            { name: 'wlan0', type: 'WiFi', state: 'UP', speed: '300 Mbps', ip: '192.168.1.1', mac: 'AA:BB:CC:11:22:35' },
            { name: 'wlan1', type: 'WiFi', state: 'DOWN', speed: 'N/A', ip: 'N/A', mac: 'AA:BB:CC:11:22:36' }
        ];
        
        // Costruisci la presentazione
        let html = '<div class="table-responsive"><table class="table table-hover">';
        html += '<thead><tr><th>Interfaccia</th><th>Tipo</th><th>Stato</th><th>Velocità</th><th>Indirizzo IP</th><th>MAC</th></tr></thead><tbody>';
        
        interfaces.forEach(iface => {
            const statusClass = iface.state === 'UP' ? 'status-green' : 'status-red';
            html += `
            <tr>
                <td><strong>${iface.name}</strong></td>
                <td>${iface.type}</td>
                <td><div class="d-flex align-items-center"><div class="status-indicator ${statusClass} me-2"></div> ${iface.state}</div></td>
                <td>${iface.speed}</td>
                <td>${iface.ip}</td>
                <td><span class="text-monospace">${iface.mac}</span></td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        
        html += `
        <div class="mt-3">
            <div class="alert alert-info">
                <i data-feather="info" class="me-2"></i>
                <span>Le interfacce attive sono pronte per il traffico di rete. Lo stato "DOWN" indica interfacce disabilitate o disconnesse.</span>
            </div>
        </div>`;
        
        statusArea.innerHTML = html;
        feather.replace();
    }, 1500);
}

// Aggiorna stato firewall
function updateFirewallStatus() {
    // Aggiorna indicatore stato firewall
    document.getElementById('firewallState').className = 'status-indicator status-green';
    
    // Aggiorna tabella regole firewall
    document.getElementById('firewallRulesList').innerHTML = '<tr><td colspan="4" class="text-center"><div class="spinner-border spinner-border-sm text-primary" role="status"></div> Caricamento regole...</td></tr>';
    
    setTimeout(() => {
        const firewallRules = [
            { type: 'INPUT', interface: 'eth1', protocol: 'TCP:22', action: 'ACCEPT' },
            { type: 'INPUT', interface: 'eth1', protocol: 'TCP:80,443', action: 'ACCEPT' },
            { type: 'INPUT', interface: 'eth1', protocol: 'ICMP', action: 'ACCEPT' },
            { type: 'INPUT', interface: 'eth1', protocol: 'UDP:1194', action: 'ACCEPT' },
            { type: 'INPUT', interface: 'eth0', protocol: 'ALL', action: 'ACCEPT' },
            { type: 'FORWARD', interface: 'eth1->eth0', protocol: 'ALL', action: 'ACCEPT' },
            { type: 'INPUT', interface: 'eth1', protocol: 'ALL', action: 'DROP' }
        ];
        
        let rulesHtml = '';
        firewallRules.forEach(rule => {
            const actionClass = rule.action === 'ACCEPT' ? 'text-success' : (rule.action === 'DROP' ? 'text-danger' : 'text-warning');
            rulesHtml += `
            <tr>
                <td>${rule.type}</td>
                <td>${rule.interface}</td>
                <td>${rule.protocol}</td>
                <td class="${actionClass} fw-bold">${rule.action}</td>
            </tr>`;
        });
        
        document.getElementById('firewallRulesList').innerHTML = rulesHtml;
    }, 1000);
    
    // Aggiorna tabella port forwarding
    document.getElementById('portForwardingList').innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm text-primary" role="status"></div> Caricamento regole...</td></tr>';
    
    setTimeout(() => {
        const forwardingRules = [
            { name: 'HTTP Server', external: '80', internal_ip: '192.168.1.5', internal_port: '80', protocol: 'TCP' },
            { name: 'HTTPS Server', external: '443', internal_ip: '192.168.1.5', internal_port: '443', protocol: 'TCP' },
            { name: 'SSH Access', external: '2222', internal_ip: '192.168.1.2', internal_port: '22', protocol: 'TCP' },
            { name: 'Game Server', external: '27015', internal_ip: '192.168.1.6', internal_port: '27015', protocol: 'UDP' }
        ];
        
        let forwardingHtml = '';
        forwardingRules.forEach(rule => {
            forwardingHtml += `
            <tr>
                <td>${rule.name}</td>
                <td>${rule.external}</td>
                <td>${rule.internal_ip}</td>
                <td>${rule.internal_port}</td>
                <td>${rule.protocol}</td>
            </tr>`;
        });
        
        document.getElementById('portForwardingList').innerHTML = forwardingHtml;
    }, 1200);
}

// Verifica porta
function checkPort() {
    const port = document.getElementById('portToCheck').value;
    const protocol = document.getElementById('portProtocol').value;
    
    if (!port) {
        document.getElementById('portCheckResults').innerHTML = '<div class="alert alert-danger">Errore: Specificare una porta valida.</div>';
        return;
    }
    
    document.getElementById('portCheckResults').innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Controllo porta in corso...</p></div>';
    
    // Simula verifica
    setTimeout(() => {
        // Genera un risultato casuale
        const isOpen = Math.random() > 0.7; // 30% di probabilità che sia aperta
        
        if (isOpen) {
            const output = `Porta ${port}/${protocol.toUpperCase()} APERTA 
            
Dettagli:
- IP esterno: 203.0.113.10
- Porta: ${port}
- Protocollo: ${protocol.toUpperCase()}
- Stato: APERTA
- Servizio rilevato: ${getRandomService(port)}

La porta è accessibile da internet.`;
            
            document.getElementById('portCheckResults').innerHTML = `
            <div class="alert alert-success mb-3">
                <div class="d-flex">
                    <div class="me-2"><i data-feather="check-circle"></i></div>
                    <div>La porta ${port}/${protocol.toUpperCase()} è <strong>APERTA</strong> e accessibile da internet.</div>
                </div>
            </div>
            <pre>${output}</pre>`;
        } else {
            const output = `Porta ${port}/${protocol.toUpperCase()} CHIUSA 
            
Dettagli:
- IP esterno: 203.0.113.10
- Porta: ${port}
- Protocollo: ${protocol.toUpperCase()}
- Stato: CHIUSA/FILTRATA
- Risultato: Timeout o connessione rifiutata

La porta non è accessibile da internet. Possibili cause:
- Il port forwarding non è configurato
- Un firewall sta bloccando la connessione
- Il servizio non è in ascolto su questa porta`;
            
            document.getElementById('portCheckResults').innerHTML = `
            <div class="alert alert-danger mb-3">
                <div class="d-flex">
                    <div class="me-2"><i data-feather="x-circle"></i></div>
                    <div>La porta ${port}/${protocol.toUpperCase()} è <strong>CHIUSA</strong> o filtrata.</div>
                </div>
            </div>
            <pre>${output}</pre>`;
        }
        
        feather.replace();
    }, 2000);
}

// Servizio casuale per una porta
function getRandomService(port) {
    const services = {
        '21': 'FTP',
        '22': 'SSH',
        '23': 'Telnet',
        '25': 'SMTP',
        '53': 'DNS',
        '80': 'HTTP',
        '443': 'HTTPS',
        '3389': 'Remote Desktop',
        '1194': 'OpenVPN'
    };
    
    if (services[port]) {
        return services[port];
    }
    
    return 'Sconosciuto';
}

// Carica log di sistema
function loadSystemLogs() {
    const logType = document.getElementById('logType').value;
    
    document.getElementById('systemLogsList').innerHTML = '<tr><td colspan="4" class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Caricamento log...</p></td></tr>';
    
    // Simula caricamento
    setTimeout(() => {
        // Log simulati
        const systemLogs = [
            { date: '2023-07-15 08:12:34', type: 'system', level: 'info', message: 'Sistema avviato correttamente' },
            { date: '2023-07-15 08:12:40', type: 'network', level: 'info', message: 'Interfaccia eth0 configurata: 192.168.1.1/24' },
            { date: '2023-07-15 08:12:45', type: 'network', level: 'info', message: 'Interfaccia eth1 configurata via DHCP: 203.0.113.10' },
            { date: '2023-07-15 08:13:01', type: 'firewall', level: 'info', message: 'Regole firewall applicate correttamente' },
            { date: '2023-07-15 09:23:15', type: 'security', level: 'warning', message: 'Tentativo di accesso fallito: user admin, IP 185.12.45.67' },
            { date: '2023-07-15 10:45:22', type: 'network', level: 'warning', message: 'Pacchetti persi su interfaccia WAN: 5%' },
            { date: '2023-07-15 11:01:48', type: 'system', level: 'info', message: 'Aggiornamento software disponibile: v1.2.4' },
            { date: '2023-07-15 12:10:33', type: 'security', level: 'error', message: 'Múltipli tentativi di accesso bloccati da 23.45.67.89' },
            { date: '2023-07-15 14:30:11', type: 'firewall', level: 'info', message: 'Connessione bloccata verso 12.34.56.78:445 (porte SMB)' },
            { date: '2023-07-15 15:22:09', type: 'network', level: 'error', message: 'Interfaccia WAN disconnessa' },
            { date: '2023-07-15 15:24:51', type: 'network', level: 'info', message: 'Interfaccia WAN riconnessa: 203.0.113.15' }
        ];
        
        // Filtra per tipo se necessario
        let filteredLogs = systemLogs;
        if (logType !== 'all') {
            filteredLogs = systemLogs.filter(log => log.type === logType);
        }
        
        // Costruisci la tabella
        let logsHtml = '';
        
        if (filteredLogs.length === 0) {
            logsHtml = '<tr><td colspan="4" class="text-center">Nessun log trovato per il tipo selezionato.</td></tr>';
        } else {
            filteredLogs.forEach(log => {
                const levelClass = log.level === 'info' ? 'text-info' : (log.level === 'warning' ? 'text-warning' : 'text-danger');
                logsHtml += `
                <tr>
                    <td>${log.date}</td>
                    <td>${log.type}</td>
                    <td class="${levelClass}">${log.level}</td>
                    <td>${log.message}</td>
                </tr>`;
            });
        }
        
        document.getElementById('systemLogsList').innerHTML = logsHtml;
    }, 1500);
}

// Controllo stato QoS
function checkQosStatus() {
    // Simulazione già implementata con dati statici
    console.log('QoS status check triggered');
}

// Test qualità VoIP
function testVoipQuality() {
    const resultsArea = document.getElementById('voipTestResults');
    resultsArea.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Test VoIP in corso...</p><p class="small text-muted">Simulazione chiamata e verifica qualità...</p></div>';
    
    // Simulazione test
    setTimeout(() => {
        const mosScore = (Math.random() * 1) + 3.2; // 3.2-4.2
        const latency = Math.floor(Math.random() * 50) + 10; // 10-60 ms
        const jitter = Math.floor(Math.random() * 8) + 1; // 1-9 ms
        const packetLoss = Math.random() * 2; // 0-2%
        
        document.getElementById('voipQualitySummary').classList.remove('d-none');
        
        // Aggiorna risultati
        document.getElementById('mosScore').textContent = mosScore.toFixed(1);
        document.getElementById('voipLatency').textContent = latency + ' ms';
        document.getElementById('voipJitter').textContent = jitter + ' ms';
        document.getElementById('voipPacketLoss').textContent = packetLoss.toFixed(1) + '%';
        
        // Determina il verdetto
        const verdictElement = document.getElementById('voipQualityVerdict');
        const verdictAlert = verdictElement.parentElement.parentElement;
        
        let verdict = '';
        if (mosScore >= 4.0 && latency < 30 && jitter < 5 && packetLoss < 0.5) {
            verdict = 'Eccellente qualità per chiamate VoIP';
            verdictAlert.className = 'alert alert-success mb-0';
        } else if (mosScore >= 3.5 && latency < 50 && jitter < 10 && packetLoss < 1) {
            verdict = 'Buona qualità per chiamate VoIP';
            verdictAlert.className = 'alert alert-primary mb-0';
        } else if (mosScore >= 3.0 && latency < 100 && jitter < 15 && packetLoss < 2) {
            verdict = 'Qualità accettabile per chiamate VoIP';
            verdictAlert.className = 'alert alert-warning mb-0';
        } else {
            verdict = 'Qualità scadente per chiamate VoIP, possibili problemi';
            verdictAlert.className = 'alert alert-danger mb-0';
        }
        
        verdictElement.textContent = verdict;
        
        // Mostra dettagli test
        let testDetails = `Test qualità VoIP completato\n\n`;
        testDetails += `MOS (Mean Opinion Score): ${mosScore.toFixed(1)}/5.0\n`;
        testDetails += `Latenza media: ${latency} ms\n`;
        testDetails += `Jitter: ${jitter} ms\n`;
        testDetails += `Perdita di pacchetti: ${packetLoss.toFixed(1)}%\n\n`;
        
        testDetails += `Protocolli testati:\n`;
        testDetails += `- SIP (Session Initiation Protocol)\n`;
        testDetails += `- RTP (Real-time Transport Protocol)\n\n`;
        
        testDetails += `Codec verificati:\n`;
        testDetails += `- G.711 (PCM): Ottimo\n`;
        testDetails += `- G.729 (CS-ACELP): Buono\n`;
        testDetails += `- Opus: Ottimo\n\n`;
        
        testDetails += mosScore >= 3.5 ? 
            `La rete è adatta per chiamate VoIP di buona qualità.` : 
            `Si consiglia di verificare la configurazione di rete per migliorare la qualità VoIP.`;
        
        resultsArea.textContent = testDetails;
        
        feather.replace();
    }, 3000);
}

// Verifica stato server VPN
function checkVpnServerStatus() {
    const resultsArea = document.getElementById('vpnServerResults');
    resultsArea.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Verifica stato server VPN...</p></div>';
    
    // Simulazione verifica
    setTimeout(() => {
        // Genera casualmente stato server
        const isRunning = Math.random() > 0.2; // 80% probabilità che sia attivo
        
        if (isRunning) {
            const serverInfo = `Server OpenVPN Attivo
Status: Running
Porta: 1194/UDP
Clients connessi: 2
Subnet VPN: 10.8.0.0/24
Bandwidth: ↓ 1.2 Mbps / ↑ 0.8 Mbps

Diagnostica:
✓ Servizio attivo
✓ Porta 1194 accessibile
✓ Routing funzionante
✓ Configurazione TLS valida
✓ Certificati validi (scadenza: 2024-12-31)
`;
            
            resultsArea.innerHTML = `
            <div class="alert alert-success mb-3">
                <div class="d-flex">
                    <div class="me-2"><i data-feather="check-circle"></i></div>
                    <div>Server VPN attivo e funzionante</div>
                </div>
            </div>
            <pre class="bg-light p-3 mb-0 rounded">${serverInfo}</pre>`;
        } else {
            const errorInfo = `Server OpenVPN Inattivo
Status: Stopped
Errore: Il servizio OpenVPN non è in esecuzione

Diagnostica:
✓ Configurazione valida
✓ Certificati validi
✗ Servizio non attivo
✗ Porta 1194 non in ascolto

Possibili soluzioni:
1. Avviare manualmente il servizio VPN
2. Verificare i log di sistema per errori
3. Controllare che non ci siano conflitti di porta
`;
            
            resultsArea.innerHTML = `
            <div class="alert alert-danger mb-3">
                <div class="d-flex">
                    <div class="me-2"><i data-feather="x-circle"></i></div>
                    <div>Server VPN non attivo</div>
                </div>
            </div>
            <pre class="bg-light p-3 mb-0 rounded">${errorInfo}</pre>`;
        }
        
        feather.replace();
    }, 2000);
}

// Test client VPN
function testVpnClient() {
    const client = document.getElementById('vpnClientToTest').value;
    const resultsArea = document.getElementById('vpnClientResults');
    
    if (!client) {
        resultsArea.innerHTML = '<div class="alert alert-warning">Seleziona un client VPN da testare.</div>';
        return;
    }
    
    resultsArea.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Test connessione client VPN...</p></div>';
    
    // Simulazione test
    setTimeout(() => {
        // Genera casualmente stato client
        const isConnected = Math.random() > 0.3; // 70% probabilità che sia connesso
        
        if (isConnected) {
            const clientInfo = `Client: ${client}
Status: Connesso
IP VPN: 10.8.0.${client === 'client1' ? '2' : (client === 'client2' ? '3' : '4')}
Connesso da: ${Math.floor(Math.random() * 24) + 1} ore
Encrypted data: ↓ ${Math.floor(Math.random() * 100) + 10} MB / ↑ ${Math.floor(Math.random() * 50) + 5} MB

Test connettività:
✓ Ping al server: ${Math.floor(Math.random() * 30) + 10} ms
✓ Accesso risorse interne: OK
✓ Routing corretto
✓ MTU ottimale (1500)
`;
            
            resultsArea.innerHTML = `
            <div class="alert alert-success mb-3">
                <div class="d-flex">
                    <div class="me-2"><i data-feather="check-circle"></i></div>
                    <div>Client VPN connesso e funzionante</div>
                </div>
            </div>
            <pre class="bg-light p-3 mb-0 rounded">${clientInfo}</pre>`;
        } else {
            const errorInfo = `Client: ${client}
Status: Disconnesso
Ultimo accesso: ${Math.floor(Math.random() * 5) + 1} giorni fa

Diagnostica:
✗ Client non connesso
✓ Configurazione valida
✓ Certificato client valido

Possibili soluzioni:
1. Verificare la connessione internet del client
2. Controllare che il client VPN sia in esecuzione
3. Verificare che le credenziali siano corrette
`;
            
            resultsArea.innerHTML = `
            <div class="alert alert-danger mb-3">
                <div class="d-flex">
                    <div class="me-2"><i data-feather="x-circle"></i></div>
                    <div>Client VPN non connesso</div>
                </div>
            </div>
            <pre class="bg-light p-3 mb-0 rounded">${errorInfo}</pre>`;
        }
        
        feather.replace();
    }, 1800);
}

// Analisi routing VPN
function analyzeVpnRouting() {
    const resultsArea = document.getElementById('vpnRoutingResults');
    const splitTunneling = document.getElementById('splitTunnelingEnabled').checked;
    
    resultsArea.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Analisi routing VPN in corso...</p><p class="small text-muted">Questo può richiedere alcuni secondi...</p></div>';
    
    // Simulazione analisi
    setTimeout(() => {
        const routingInfo = `Analisi Routing VPN
=================
Split Tunneling: ${splitTunneling ? 'Attivo' : 'Disattivo'}
${splitTunneling ? 'Solo il traffico selezionato viene instradato attraverso la VPN' : 'Tutto il traffico viene instradato attraverso la VPN'}

Test routing:
${splitTunneling ? 
'✓ Traffico locale (192.168.1.0/24): Diretto\n✓ Internet (0.0.0.0/0): Diretto\n✓ Reti aziendali (10.0.0.0/8): Tramite VPN' : 
'✓ Traffico locale (192.168.1.0/24): Diretto\n✓ Internet (0.0.0.0/0): Tramite VPN\n✓ DNS: Tramite VPN'}

Tabella routing:
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
0.0.0.0         ${splitTunneling ? '192.168.1.1' : '10.8.0.1'}     0.0.0.0         UG      0   0       0    ${splitTunneling ? 'eth0' : 'tun0'}
10.8.0.0        0.0.0.0         255.255.255.0   U       0   0       0    tun0
${splitTunneling ? '10.0.0.0        10.8.0.1        255.0.0.0       UG      0   0       0    tun0' : ''}
192.168.1.0     0.0.0.0         255.255.255.0   U       0   0       0    eth0
`;
        
        resultsArea.innerHTML = `
        <div class="alert alert-${splitTunneling ? 'info' : 'success'} mb-3">
            <div class="d-flex">
                <div class="me-2"><i data-feather="${splitTunneling ? 'info' : 'check-circle'}"></i></div>
                <div>Routing VPN ${splitTunneling ? 'parziale (split tunneling)' : 'completo'}</div>
            </div>
        </div>
        <pre class="bg-light p-3 mb-0 rounded">${routingInfo}</pre>
        
        <div class="mt-3">
            <p class="mb-2"><strong>Note sul routing VPN:</strong></p>
            <ul class="mb-0">
                <li>${splitTunneling ? 
                      'Con lo split tunneling, solo il traffico verso specifiche reti viene instradata attraverso la VPN. Questo può migliorare le prestazioni ma riduce la sicurezza.' : 
                      'Con il routing completo, tutto il traffico internet passa attraverso la VPN. Questo fornisce massima sicurezza ma può ridurre la velocità di connessione.'}</li>
                <li>Le connessioni alle risorse locali (come stampanti o NAS) non sono influenzate dalla configurazione VPN.</li>
            </ul>
        </div>`;
        
        feather.replace();
    }, 2500);
}
</script>
{% endblock %}