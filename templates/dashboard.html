{% extends "layout.html" %}

{% block title %}Dashboard - BPI-R4 Router{% endblock %}

{% block extra_css %}
<style>
    .card-dashboard {
        height: 100%;
    }
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    .status-up {
        background-color: #28a745;
    }
    .status-down {
        background-color: #dc3545;
    }
    .status-unknown {
        background-color: #ffc107;
    }
    .network-chart-container {
        height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-outline-secondary" id="refresh-dashboard">
            <i class="fas fa-sync-alt me-1"></i> Refresh
        </button>
    </div>
</div>

<div class="row">
    <!-- System Info Card -->
    <div class="col-md-6 mb-4">
        <div class="card card-dashboard shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-server me-2"></i>System Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Hostname:</strong> <span id="hostname">{{ system_info.hostname }}</span></p>
                        <p><strong>Platform:</strong> <span id="platform">{{ system_info.platform }}</span></p>
                        <p><strong>CPU Model:</strong> <span id="cpu-model">{{ system_info.cpu_model }}</span></p>
                        <p><strong>Kernel:</strong> <span id="kernel">{{ system_info.kernel_version }}</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Uptime:</strong> <span id="uptime">{{ system_info.uptime|default(0)|int // 86400 }} days {{ (system_info.uptime|default(0)|int % 86400) // 3600 }} hours</span></p>
                        <p><strong>Memory:</strong> <span id="memory">{{ (system_info.memory_total|default(0) / (1024*1024*1024))|round(2) }} GB</span></p>
                        <p><strong>Disk:</strong> <span id="disk">{{ (system_info.disk_total|default(0) / (1024*1024*1024))|round(2) }} GB</span></p>
                        <p><strong>Temperature:</strong> <span id="temperature">N/A</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Network Status Card -->
    <div class="col-md-6 mb-4">
        <div class="card card-dashboard shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-network-wired me-2"></i>Network Status</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Interface</th>
                            <th>Status</th>
                            <th>IP Address</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for iface, info in network_status.items() %}
                        <tr>
                            <td>{{ iface }}</td>
                            <td>
                                {% if info.status == 'up' %}
                                <span class="status-indicator status-up"></span> Up
                                {% else %}
                                <span class="status-indicator status-down"></span> Down
                                {% endif %}
                            </td>
                            <td>{{ info.ip_address }}</td>
                            <td>{{ info.is_wireless|default(false) and 'Wireless' or 'Wired' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Network Traffic Chart -->
    <div class="col-md-8 mb-4">
        <div class="card card-dashboard shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Network Traffic</h5>
            </div>
            <div class="card-body">
                <div class="network-chart-container">
                    <canvas id="networkChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- FreeSWITCH Status Card -->
    <div class="col-md-4 mb-4">
        <div class="card card-dashboard shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-phone me-2"></i>FreeSWITCH Status</h5>
            </div>
            <div class="card-body">
                <div id="freeswitch-status">
                    <p><strong>Status:</strong> <span id="fs-status"><span class="status-indicator status-unknown"></span> Unknown</span></p>
                    <p><strong>Active Calls:</strong> <span id="fs-calls">0</span></p>
                    <p><strong>Registrations:</strong> <span id="fs-regs">0</span></p>
                    <p><strong>Uptime:</strong> <span id="fs-uptime">0 minutes</span></p>
                </div>
                <hr>
                <h6>Extensions</h6>
                <ul class="list-group">
                    {% for ext in extensions %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ ext.extension }} ({{ ext.name }})
                        <span class="badge bg-primary rounded-pill" id="ext-status-{{ ext.extension }}">Offline</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- System Logs Card -->
    <div class="col-md-12 mb-4">
        <div class="card card-dashboard shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Recent System Logs</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Level</th>
                                <th>Source</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in recent_logs %}
                            <tr class="{% if log.level == 'error' %}table-danger{% elif log.level == 'warning' %}table-warning{% endif %}">
                                <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td>{{ log.level }}</td>
                                <td>{{ log.source }}</td>
                                <td>{{ log.message }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
    // Initialize network traffic chart
    const ctx = document.getElementById('networkChart').getContext('2d');
    const networkChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array(30).fill('').map((_, i) => `-${30-i}s`),
            datasets: [
                {
                    label: 'Download (Bytes/s)',
                    data: Array(30).fill(0),
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.4
                },
                {
                    label: 'Upload (Bytes/s)',
                    data: Array(30).fill(0),
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            if (value >= 1000000) return (value/1000000).toFixed(1) + ' MB';
                            if (value >= 1000) return (value/1000).toFixed(1) + ' KB';
                            return value + ' B';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            let value = context.parsed.y;
                            if (value >= 1000000) return label + ': ' + (value/1000000).toFixed(2) + ' MB/s';
                            if (value >= 1000) return label + ': ' + (value/1000).toFixed(2) + ' KB/s';
                            return label + ': ' + value + ' B/s';
                        }
                    }
                }
            }
        }
    });

    let prevNetStats = null;
    
    // Function to update dashboard data
    function updateDashboard() {
        // Update system stats
        fetch('/api/dashboard/stats')
            .then(response => response.json())
            .then(data => {
                if (data.system) {
                    // Update system stats
                    document.getElementById('temperature').textContent = 
                        data.system.cpu_temperature ? data.system.cpu_temperature.toFixed(1) + '°C' : 'N/A';
                    
                    // Update network chart
                    if (data.network && prevNetStats) {
                        const timeDiff = 2; // Assume 2 second update interval
                        let totalRx = 0;
                        let totalTx = 0;
                        
                        for (const iface in data.network.interfaces) {
                            if (iface === 'lo') continue; // Skip loopback
                            
                            const current = data.network.interfaces[iface];
                            const prev = prevNetStats.interfaces[iface] || { bytes_recv: 0, bytes_sent: 0 };
                            
                            totalRx += Math.max(0, (current.bytes_recv - prev.bytes_recv) / timeDiff);
                            totalTx += Math.max(0, (current.bytes_sent - prev.bytes_sent) / timeDiff);
                        }
                        
                        // Add new data points
                        networkChart.data.datasets[0].data.push(totalRx);
                        networkChart.data.datasets[1].data.push(totalTx);
                        
                        // Remove old data points
                        if (networkChart.data.datasets[0].data.length > 30) {
                            networkChart.data.datasets[0].data.shift();
                            networkChart.data.datasets[1].data.shift();
                        }
                        
                        networkChart.update();
                    }
                    
                    prevNetStats = data.network;
                }
            })
            .catch(error => console.error('Error fetching dashboard stats:', error));
        
        // Update FreeSWITCH status
        fetch('/freeswitch/registrations')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const registrations = data.registrations || [];
                    
                    // Update extension statuses
                    document.querySelectorAll('[id^="ext-status-"]').forEach(el => {
                        el.textContent = 'Offline';
                        el.classList.remove('bg-success');
                        el.classList.add('bg-secondary');
                    });
                    
                    registrations.forEach(reg => {
                        const extElement = document.getElementById(`ext-status-${reg.extension}`);
                        if (extElement) {
                            extElement.textContent = 'Online';
                            extElement.classList.remove('bg-secondary');
                            extElement.classList.add('bg-success');
                        }
                    });
                    
                    // Update FreeSWITCH status
                    document.getElementById('fs-status').innerHTML = 
                        '<span class="status-indicator status-up"></span> Running';
                    document.getElementById('fs-regs').textContent = registrations.length;
                }
            })
            .catch(error => {
                console.error('Error fetching FreeSWITCH status:', error);
                document.getElementById('fs-status').innerHTML = 
                    '<span class="status-indicator status-down"></span> Not Running';
            });
    }
    
    // Update dashboard on load and every 2 seconds
    updateDashboard();
    setInterval(updateDashboard, 2000);
    
    // Refresh button
    document.getElementById('refresh-dashboard').addEventListener('click', updateDashboard);
</script>
{% endblock %}
